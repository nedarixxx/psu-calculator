{% extends 'calculator/base.html' %}

{% block title %}{{ build.title }} - PSU Calculator{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="fas fa-cube"></i>{{ build.title }}</h2>
            <div>
                <a href="{% url 'calculator:build_edit' build.pk %}" class="btn btn-warning">
                    <i class="fas fa-edit"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                </a>
                <a href="{% url 'calculator:build_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>–ù–∞–∑–∞–¥
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Left: Components & Add Component & Description -->
    <div class="col-lg-6 mb-4">
        <!-- Components Table -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-microchip"></i>–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã</h5>
            </div>
            <div class="card-body">
                {% if components %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th>–ö–æ–º–ø–æ–Ω–µ–Ω—Ç</th>
                                <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                <th>–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for component in components %}
                            <tr>
                                <td>{{ component.name }}</td>
                                <td>
                                    <span class="badge bg-info">{{ component.category.name }}</span>
                                </td>
                                <td>
                                    <strong>{{ component.power_draw }}W</strong>
                                </td>
                                <td>
                                    <form method="POST" action="{% url 'calculator:remove_component' build.pk component.pk %}" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-outline-danger" title="–£–¥–∞–ª–∏—Ç—å">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center">–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –Ω–µ—Ç. –î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–∏–∂–µ.</p>
                {% endif %}
            </div>
        </div>

        <!-- Add Component Form -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-plus-circle"></i>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç</h5>
            </div>
            <div class="card-body">
                <form method="POST" id="addComponentForm">
                    {% csrf_token %}
                    <input type="hidden" name="add_component" value="1">
                    
                    <!-- –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
                    <div class="mb-3">
                        <label for="id_category" class="form-label">
                            <i class="fas fa-folder"></i> –ö–∞—Ç–µ–≥–æ—Ä–∏—è
                        </label>
                        {{ form.category }}
                        {% if form.category.errors %}
                        <div class="alert alert-danger mt-2">{{ form.category.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <!-- –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é -->
                    <div class="mb-3">
                        <label for="id_search" class="form-label">
                            <i class="fas fa-search"></i> –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
                        </label>
                        {{ form.search }}
                        {% if form.search.errors %}
                        <div class="alert alert-danger mt-2">{{ form.search.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <!-- –í—ã–±–æ—Ä –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ -->
                    <div class="mb-3">
                        <label for="id_component" class="form-label">
                            <i class="fas fa-microchip"></i> –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
                        </label>
                        {{ form.component }}
                        {% if form.component.errors %}
                        <div class="alert alert-danger mt-2">{{ form.component.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <button type="submit" class="btn btn-success w-100">
                        <i class="fas fa-plus"></i>–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–±–æ—Ä–∫—É
                    </button>
                </form>
            </div>
        </div>

        <!-- Description -->
        {% if build.description %}
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-sticky-note"></i>–û–ø–∏—Å–∞–Ω–∏–µ</h5>
            </div>
            <div class="card-body">
                {{ build.description }}
            </div>
        </div>
        {% endif %}

        <!-- Metadata -->
        <div class="card">
            <div class="card-body">
                <small class="text-muted d-block">
                    <i class="fas fa-calendar"></i>
                    –°–æ–∑–¥–∞–Ω–æ: {{ build.created_at|date:"d.m.Y –≤ H:i" }}<br>
                    <i class="fas fa-sync"></i>
                    –û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ build.updated_at|date:"d.m.Y –≤ H:i" }}
                </small>
            </div>
        </div>
    </div>

    <!-- Right: Analytics -->
    <div class="col-lg-6 mb-4">
        <!-- Power Summary -->
        <div class="card mb-3">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="fas fa-bolt"></i>–†–∞—Å—á–µ—Ç —ç–Ω–µ—Ä–≥–æ–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <div class="stat-box">
                            <h3>{{ analytics.total_power }}W</h3>
                            <p>–¢–∏–ø–∏—á–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ</p>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-box">
                            <h3>{{ analytics.peak_power }}W</h3>
                            <p>–ü–∏–∫–æ–≤–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ<br><small>(—Å—É–º–º–∞ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤)</small></p>
                        </div>
                    </div>
                </div>

                <!-- GPU Recommendation -->
                {% if analytics.gpu_psu > 0 %}
                <div class="alert alert-warning mt-3" style="background-color: #fff3cd; border: 2px solid #ffc107;">
                    <strong><i class="fas fa-video"></i> –í–∏–¥–µ–æ–∫–∞—Ä—Ç–∞: {{ analytics.gpu_name }}</strong><br>
                    <span style="color: #ff9800; font-size: 1.1em;">üìå –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è (–ø—Ä–∏–º–µ—Ä–Ω–æ): <strong>{{ analytics.gpu_psu }}W</strong></span>
                    <br><small>–≠—Ç–æ –º–∏–Ω–∏–º—É–º –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –≤–∏–¥–µ–æ–∫–∞—Ä—Ç—ã</small>
                </div>
                {% endif %}

                <!-- Build Recommendation -->
                <div class="alert alert-danger mt-3" style="background-color: #f8d7da; border: 2px solid #dc3545;">
                    <strong><i class="fas fa-cog"></i>‚úÖ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –±–ª–æ–∫ –ø–∏—Ç–∞–Ω–∏—è –¥–ª—è —Å–±–æ—Ä–∫–∏ (–ø—Ä–∏–º–µ—Ä–Ω–æ):</strong><br>
                    <strong style="color: #c0392b; font-size: 1.4em;">{{ analytics.build_psu }}W</strong>
                    <br>
                    <small>
                        –†–∞—Å—á–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–∏–∫–æ–≤–æ–≥–æ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è {{ analytics.peak_power }}W 
                        —Å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ 1.25x
                    </small>
                </div>
                
                {% if analytics.total_power > 0 %}
                <div class="alert alert-info mt-3">
                    <strong><i class="fas fa-lightbulb"></i>–°–≤–æ–¥–∫–∞ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è:</strong><br>
                    ‚Ä¢ <strong>–¢–∏–ø–∏—á–Ω–æ–µ:</strong> {{ analytics.total_power }}W (–ø—Ä–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ)<br>
                    ‚Ä¢ <strong>–ü–∏–∫–æ–≤–æ–µ:</strong> {{ analytics.peak_power }}W (–ø—Ä–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ)<br>
                    ‚Ä¢ <strong>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ë–ü:</strong> {{ analytics.build_psu }}W
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Power by Category -->
        {% if analytics.categories_power %}
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie"></i>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h5>
            </div>
            <div class="card-body">
                <!-- Pie Chart -->
                {% if chart_image %}
                <div class="text-center mb-3">
                    <img src="data:image/png;base64,{{ chart_image }}" alt="Pie Chart" class="img-fluid" style="max-width: 100%; height: auto;">
                </div>
                {% endif %}

                <!-- Power Table -->
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                            <th>–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ</th>
                            <th>–ü—Ä–æ—Ü–µ–Ω—Ç</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in analytics.categories_power %}
                        <tr>
                            <td>{{ item.category }}</td>
                            <td><strong>{{ item.power }}W</strong></td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar" role="progressbar" 
                                         style="width: {{ item.percentage }}%;" 
                                         aria-valuenow="{{ item.percentage }}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        {{ item.percentage }}%
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- ‚úÖ –ù–û–í–û–ï: Recommended PSU -->
        {% if recommended_psus %}
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-plug"></i>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –±–ª–æ–∫–∏ –ø–∏—Ç–∞–Ω–∏—è</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    <small>–ë–ª–æ–∫–∏ –º–æ—â–Ω–æ—Å—Ç—å—é <strong>{{ analytics.build_psu|add:"-50" }}W - {{ analytics.build_psu|add:"50" }}W</strong></small>
                </p>
                
                <div class="row">
                    {% for psu in recommended_psus %}
                    <div class="col-12 mb-2">
                        <div class="card border-success" style="background-color: rgba(40, 167, 69, 0.05);">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">{{ psu.name }}</h6>
                                        <small class="text-muted">
                                            <i class="fas fa-bolt"></i> 
                                            <strong>{{ psu.power_draw }}W</strong>
                                            {% if psu.power_draw == analytics.build_psu %}
                                            <span class="badge bg-success ms-2">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è</span>
                                            {% elif psu.power_draw > analytics.build_psu %}
                                            <span class="badge bg-info ms-2">+{{ psu.power_draw|add:"-"|add:analytics.build_psu }}W</span>
                                            {% else %}
                                            <span class="badge bg-warning ms-2">-{{ analytics.build_psu|add:"-"|add:psu.power_draw }}W</span>
                                            {% endif %}
                                        </small>
                                    </div>
                                    <div class="text-end">
                                        {% if psu.price %}
                                        <div style="font-size: 1.1em; font-weight: bold; color: #28a745;">
                                            {{ psu.price }}‚ÇΩ
                                        </div>
                                        <small class="text-muted">—Ü–µ–Ω–∞</small>
                                        {% else %}
                                        <small class="text-muted">—Ü–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                {% if not recommended_psus %}
                <div class="alert alert-info mb-0">
                    <small><i class="fas fa-info-circle"></i> –ü–æ–¥—Ö–æ–¥—è—â–∏—Ö –±–ª–æ–∫–æ–≤ –ø–∏—Ç–∞–Ω–∏—è –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</small>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- JavaScript –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.querySelector('[name="category"]');
    const searchInput = document.querySelector('[name="search"]');
    const componentSelect = document.querySelector('[name="component"]');
    
    if (!categorySelect || !searchInput || !componentSelect) {
        console.error('–≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
        return;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å –∏—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
    const categoryMap = {
        {% for component in form.component.field.queryset %}
        "{{ component.id }}": "{{ component.category_id }}",
        {% endfor %}
    };
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏
    const originalOptions = Array.from(componentSelect.options).map(opt => ({
        value: opt.value,
        text: opt.text
    }));
    
    function filterComponents() {
        const selectedCategory = categorySelect.value.trim();
        const searchText = searchInput.value.toLowerCase().trim();
        
        // –û—á–∏—â–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—É—é –æ–ø—Ü–∏—é
        componentSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç --</option>';
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏
        originalOptions.forEach(opt => {
            if (opt.value === '') return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—É—é –æ–ø—Ü–∏—é
            
            const componentCategoryId = String(categoryMap[opt.value] || '');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
            const matchCategory = !selectedCategory || componentCategoryId === selectedCategory;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–∏—Å–∫
            const matchSearch = !searchText || opt.text.toLowerCase().includes(searchText);
            
            // –ï—Å–ª–∏ –æ–±–∞ —É—Å–ª–æ–≤–∏—è –≤–µ—Ä–Ω—ã - –¥–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é
            if (matchCategory && matchSearch) {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.text;
                componentSelect.appendChild(option);
            }
        });
    }
    
    // –°–æ–±—ã—Ç–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    categorySelect.addEventListener('change', filterComponents);
    searchInput.addEventListener('input', filterComponents);
});
</script>

{% endblock %}
